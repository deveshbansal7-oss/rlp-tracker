<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Dashboard â€“ RLP Tracker</title>
</head>
<body>

<h2 id="title"></h2>

<table border="1" cellpadding="6" id="table"></table>

<script>
const API = "https://script.google.com/macros/s/AKfycbzb5tQA8dMjxodKGgSW6mj3FTobb9Sc7RCK-AHjZv4FibqJB-acaLM7QniUglSYDpLo/exec";

const user = JSON.parse(localStorage.getItem("user"));

if (!user) {
  window.location.href = "index.html";
}

document.getElementById("title").innerText =
  `Welcome ${user.name} (${user.role})`;

fetch(`${API}?action=getProposals&email=${encodeURIComponent(user.email)}`)
  .then(res => res.json())
  .then(data => renderTable(data))
  .catch(err => {
    alert("Error loading proposals");
    console.error(err);
  });

function renderTable(data) {
  const table = document.getElementById("table");

  table.innerHTML = `
    <tr>
      <th>Proposal ID</th>
      <th>Branch</th>
      <th>Officer</th>
      <th>Amount</th>
      <th>Status</th>
      <th>Action</th>
    </tr>
  `;

  if (data.length === 0) {
    table.innerHTML += `<tr><td colspan="6">No proposals found</td></tr>`;
    return;
  }

  data.forEach(p => {
    const row = document.createElement("tr");

    row.innerHTML = `
      <td>${p.proposal_id}</td>
      <td>${p.branch_code}</td>
      <td>${p.officer_email || "-"}</td>
      <td>${p.amount || "-"}</td>
      <td>${p.status}</td>
      <td>
        ${user.role !== "branch" ? `
          <select onchange="updateStatus('${p.proposal_id}', this.value)">
            <option value="">Change</option>
            <option>Received</option>
            <option>Under Process</option>
            <option>Query Raised</option>
            <option>Approved</option>
            <option>Rejected</option>
          </select>
        ` : "View Only"}
      </td>
    `;

    table.appendChild(row);
  });
}

function updateStatus(proposalId, status) {
  if (!status) return;

  fetch(API, {
    method: "POST",
    body: JSON.stringify({
      action: "updateStatus",
      proposal_id: proposalId,
      status: status
    })
  })
  .then(res => res.json())
  .then(() => location.reload())
  .catch(err => {
    alert("Status update failed");
    console.error(err);
  });
}
</script>

</body>
</html>
