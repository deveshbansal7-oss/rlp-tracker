<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Dashboard â€“ RLP Tracker</title>
</head>
<body>

<h2 id="title"></h2>
  <div id="createBox" style="margin-bottom:20px; display:none;">
  <h3>Create Proposal</h3>

  <input id="branch" placeholder="Branch Code (e.g. BR001)" />
  <input id="loanType" placeholder="Loan Type" />
  <input id="amount" placeholder="Amount" type="number" />
  <input id="remarks" placeholder="Remarks (optional)" />

  <button onclick="createProposal()">Create</button>
</div>


<table border="1" cellpadding="6" id="table"></table>
<script>
const API = "https://script.google.com/macros/s/AKfycbyRBNbXMeeCdaNkQjAK_DcCSGY3_L8QIqE5vSwj8_DxXEwZQ8S1P8MOW40dvOQqFhI/exec";

const user = JSON.parse(localStorage.getItem("user"));

if (!user) {
  window.location.href = "index.html";
}

document.getElementById("title").innerText =
  `Welcome ${user.name} (${user.role})`;

if (user.role === "admin") {
  document.getElementById("createBox").style.display = "block";
}

fetch(`${API}?action=getProposals&email=${encodeURIComponent(user.email)}`)
  .then(res => res.json())
  .then(data => renderTable(data))
  .catch(err => {
    alert("Error loading proposals");
    console.error(err);
  });

function renderTable(data) {
  const table = document.getElementById("table");

  table.innerHTML = `
    <tr>
      <th>Proposal ID</th>
      <th>Branch</th>
      <th>Loan Type</th>
      <th>Officer</th>
      <th>Amount</th>
      <th>Status</th>
      <th>Action</th>
    </tr>
  `;

  if (data.length === 0) {
    table.innerHTML += `<tr><td colspan="7">No proposals found</td></tr>`;
    return;
  }

  data.forEach(p => {
    const row = document.createElement("tr");

    row.innerHTML = `
      <td>${p.proposal_id}</td>
      <td>${p.branch_code}</td>
      <td>${p.loan_type || "-"}</td>
      <td>${p.officer_email || "-"}</td>
      <td>${p.amount || "-"}</td>
      <td>${p.status}</td>
      <td>
        ${user.role !== "branch" ? `
          <select onchange="updateStatus('${p.proposal_id}', this.value)">
            <option value="">Change</option>
            <option>Received</option>
            <option>Under Process</option>
            <option>Query Raised</option>
            <option>Approved</option>
            <option>Rejected</option>
          </select>
        ` : "View Only"}
      </td>
    `;

    table.appendChild(row);
  });
}

function updateStatus(proposalId, status) {
  if (!status) return;

  fetch(API, {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      action: "updateStatus",
      proposal_id: proposalId,
      status: status
    })
  })
  .then(res => res.json())
  .then(() => location.reload())
  .catch(err => {
    alert("Status update failed");
    console.error(err);
  });
}

function createProposal() {
  const branch = document.getElementById("branch").value.trim();
  const loanType = document.getElementById("loanType").value.trim();
  const amount = document.getElementById("amount").value.trim();
  const remarks = document.getElementById("remarks").value.trim();

  if (!branch || !loanType || !amount) {
    alert("Please fill Branch, Loan Type and Amount");
    return;
  }

  fetch(API, {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      action: "createProposal",
      branch_code: branch,
      loan_type: loanType,
      amount: amount,
      remarks: remarks
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.success) {
      alert("Proposal Created: " + data.proposal_id);
      location.reload();
    } else {
      alert("Error creating proposal");
    }
  })
  .catch(err => {
    alert("Create proposal failed");
    console.error(err);
  });
}
</script>


</body>
</html>
